name: Build Windows EXE

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  win64:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Compile ArmorPaint (Release x64)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          cd paint
          ..\base\make --compile

      - name: Package runnable folder
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest

          $outDir = "paint/build/out"
          $exe = Join-Path $outDir "ArmorPaint.exe"

          if (-not (Test-Path $exe)) {
            throw "No executable found at $exe"
          }

          Compress-Archive -Path "$outDir\*" -DestinationPath "ArmorPaint-win64.zip" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArmorPaint-win64
          path: ArmorPaint-win64.zip
          if-no-files-found: error

      - name: Resolve upstream latest release tag
        id: upstream_tag
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $headers = @{ "User-Agent" = "github-actions" }
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/armory3d/armortools/releases/latest" -Headers $headers
          if (-not $release.tag_name) {
            throw "Could not determine upstream release tag."
          }
          "tag=$($release.tag_name)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Create or update release in fork
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          UPSTREAM_TAG: ${{ steps.upstream_tag.outputs.tag }}
        run: |
          Set-StrictMode -Version Latest
          if (-not $env:UPSTREAM_TAG) {
            throw "UPSTREAM_TAG is empty."
          }

          gh release view $env:UPSTREAM_TAG --repo $env:REPO *> $null
          if ($LASTEXITCODE -eq 0) {
            gh release upload $env:UPSTREAM_TAG "ArmorPaint-win64.zip" --repo $env:REPO --clobber
          }
          else {
            gh release create $env:UPSTREAM_TAG "ArmorPaint-win64.zip" --repo $env:REPO --title "ArmorPaint $env:UPSTREAM_TAG" --generate-notes
          }
